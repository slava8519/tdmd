# TDMD‑TD v4.3: аналитический отчёт о состоянии, соответствии диссертационному TD и плане развития

## Состояние реализации на v4.3: что именно уже сделано

### Численное ядро МД и базовые физические модели
К v4.3 в TDMD‑TD сформировано устойчивое численное ядро классической молекулярной динамики, в котором опорная схема интегрирования выбрана из класса симплектических (в кодовой базе проекта это **velocity‑Verlet/Верле второго порядка**). Симплектические свойства и обратимость по времени являются ключевыми требованиями для устойчивого длительного интегрирования гамильтоновых систем в МД и прямо подчёркиваются в методических и диссертационных источниках по МД. citeturn15view0

На уровне потенциалов до v4.3 поддерживается набор простых короткодействующих моделей (демонстрационные/валидационные): парные потенциалы типа Lennard‑Jones и Morse (в верификационном контуре они используются как «контролируемые» модели с быстрым расчётом и понятными тестами). Поддержка **EAM** как целевого потенциала для металлов **в v4.3 отсутствует** (см. отдельный раздел про EAM).

### TD‑архитектура: зоны, состояния, зависимости, time‑lag и буфер/skin
Ключевая часть, ради которой проект и развивался: к v4.3 реализована TD‑организация вычислений вокруг «зон» и автомата состояний.

**Диссертационный формализм.** В автореферате по теме TD‑декомпозиции при МД вводится разбиение на расчётные зоны вдоль координатной оси (иллюстрируется на рисунке; в тексте упоминается «рисунок 9») и рассматривается настройка вида «2p» зон как важная для режима работы конвейера. citeturn19search0
Там же явно описаны типы зон (в терминах «S … готовая к передаче …», и т.п.), то есть сама идея «типов зоны как состояния» присутствует в исходной теории. citeturn5search0

**Реализация в TDMD‑TD.** На v4.3 реализованы следующие элементы (в терминах инженерной спецификации проекта):

- **Фиксированный алфавит типов зон:** `F/D/P/W/S` (пустая/данные есть/частично вовлечена/в работе/готова к передаче). Это «прямая проекция» диссертационной идеи «типов зоны» (пусть и с иной нотацией). citeturn5search0
- **Формальный “core” автомата:** инвариант *«на ранге не более одной зоны в W одновременно»* (в проекте трактуется как способ сделать доказательную часть и отладку корректности существенно проще: минимизация конкурирующих операций и неоднозначностей порядка).
- **Time‑lag режим (истинный TD‑режим):** у зоны есть собственный `step_id` (временной слой зоны), и запуск вычисления ограничивается `max_step_lag` относительно зависимостей. Это приближает реализацию к «конвейеру по времени», где части системы могут находиться на разных временных слоях.
- **Физически обоснованный buffer/skin, завязанный на TD‑lag:** введена связь *буферной ширины/skin* с максимальной скоростью и временным лагом, чтобы быстрый атом не «перепрыгнул» границу корректности за окно лага. В диссертационном источнике отдельно формулируется принцип выбора ширины буферной зоны: частица не должна пройти за шаг больше ширины буфера по соответствующей координате. citeturn21search0
- **Разделение зависимостей:**
  - `table-deps` — зависимости для корректного построения таблиц взаимодействий / сил (достаточно shadow/halo),
  - `owner-deps` — зависимости для корректной маршрутизации миграций и владения (строже, обычно дороже).
  Это уже «надстройка» над диссертационным описанием, сделанная ради формальной корректности в асинхронной практической реализации.
- **Support/HALO/DELTA модель:** в проекте развёрнута единая модель данных для асинхронного TD‑обмена:
  - `HALO` как «поддержка» для сил,
  - `DELTA(MIGRATION)` как миграции атомов,
  - буферизация pending‑обновлений с лимитами на память (bounded pending).
- **Инварианты корректности на уровне геометрии support (v4.3):** для 3D‑режима введены явные счётчики/диагностика нарушений (см. ниже про 3D) — это важный шаг от «работает» к «контролируемо доказуемо работает».

### MPI‑обмен и архитектура передачи «по зонам»
К v4.3 TDMD‑TD реализует обмен не «всем миром атомов», а **зональными порциями**, то есть коммуникация структурирована вокруг зон, что соответствует диссертационной постановке «расчёт/передача/приём дискретно по зонам». citeturn19search0

По реализации важны следующие свойства:

- **Единый проволочный формат сообщений (records):** зона/дельта/halo/запросы — сериализуются как записи одного протокола, что сильно упрощает эволюцию обменов и тестирование.
- **Асинхронность и устойчивость к рассогласованиям:** добавлены pull‑механизмы (REQ для halo и карты владельцев) и версионность владения (`holder_ver`), чтобы устранить класс проблем «отправил миграцию/halo, но получатель неизвестен/неактуален».
- **Direct routing поверх “owner/holder map”:** вместо строго кольцевой передачи только соседу, сообщения могут адресоваться держателю зоны по карте владельцев (в v4.0+ это было обобщено через слой `DepsProvider`; см. следующий блок).

### 3D‑декомпозиция и обобщение на deps‑граф
До v4.3 проект прошёл путь от чистого 1D‑разбиения к полноценной поддержке 3D‑геометрии зон и зависимостей.

**Диссертационная рамка.** В автореферате явно проговаривается разбиение на зоны вдоль оси (пример вдоль `Z`) и подчёркивается, что радиус взаимодействия мал (ангстремы) относительно размера модели — это ключевое допущение локальности, на котором строятся зонные алгоритмы. citeturn20search0turn19search0

**Реализация в TDMD‑TD.** На v4.3:

- Реализовано **3D разбиение на блоки** (AABB‑зоны) и вычисление зависимостей по **пересечению AABB‑окрестности**, расширенной на радиус взаимодействия/буфер.
- Введён слой абстракции **deps‑графа** (через `DepsProvider` в v4.0+): зависимости `deps_table/deps_owner` и функция `owner_rank(zid)` отделены от конкретной топологии (1D кольца). Это ключевой архитектурный «шов», позволяющий расширять TD на произвольные графы зависимостей.
- В v4.1 реализована **3D‑корректная HALO/overlap фильтрация по AABB + PBC**, чтобы 3D‑режим не зависел от 1D‑эвристик.
- В v4.2 добавлена **3D локальная таблица взаимодействий как состояние зоны** (`InteractionTableState.impl = CellList`), то есть «локальная таблица» стала реальным объектом, а не побочным эффектом расчёта.
- В v4.3 расширена «доказательная инфраструктура»: таблица хранит 3D‑геометрию support, и вводятся измеримые инвариант‑нарушения `tG3/hG3/hV3` (табличная геометрия/геометрия halo/halo⊂support).

### Строгие механизмы верификации: verify2 → verifylab → golden → chaos
К v4.3 сформирован полноценный научный верификационный контур, который существенно выходит за рамки «сравнить координаты»:

- **verify2:** сравнение `serial` и `td_local` не только по `max|dr|/max|dv|`, но и по базовым наблюдаемым **E, T, P** (энергия/температура/давление) и их расхождениям.
  Подход «температура из средней кинетической энергии по распределению по степеням свободы» является стандартным и внятно формулируется в учебно‑диссертационных материалах. citeturn15view0
- **verifylab:** лабораторный свип параметров (число зон, режим Verlet/skin, шаг перестройки, max_step_lag, chaos‑параметры), вывод CSV и построение графиков.
- **Golden trajectories:** хранение эталонных временных рядов (минимально: E/T/P) от `serial` для фиксированных тест‑кейсов и проверка `td_local` против эталона — это переход к регрессионной науке («сломалось на коммите» фиксируется автоматически).
- **Chaos‑режим:** контролируемая рандомизация расписания обработки зон и вероятностные задержки применения DELTA/HALO, имитирующие неблагоприятные перестановки доставки/применения данных. Это аналог «стресс‑теста асинхронности», без которого TD‑реализация часто выглядит корректной только в «счастливом» порядке событий.

## Соответствие диссертационной теории TD: сильные совпадения и реальные расхождения

### Где совпадение высокое и принципиальное
**Типы зон как состояние вычисления.** Диссертационный текст явно вводит идею разных «типов» (состояний) расчётных зон (например, зона «S» как готовая к передаче и т.п.). citeturn5search0
TDMD‑TD следует этому принципу: расчёт организован не вокруг «системы целиком», а вокруг зон и их состояния (`F/D/P/W/S`).

**Локальность радиуса взаимодействия как основание зонности.** В автореферате подчёркивается физический факт: радиус взаимодействия размеров ангстрем и мал относительно размера моделируемой области; на этом основана идея локальных подпространств/зон. citeturn20search0
В реализации TDMD‑TD эта локальность материализована через `cutoff`, `buffer/skin` и локальные таблицы/halo.

**Настройка числа зон порядка 2P как условие режима конвейера.** В автореферате упоминается режим построения и параметризация вида «2p» зон вдоль оси, связанная с организацией TD‑процесса. citeturn19search0
В TDMD‑TD это отражено через режимы `fast_sync/strict_fast_sync` и детерминированный старт распределения зон.

**Буферная зона как физическая гарантия.** В диссертационном источнике формулируется критерий выбора буферной ширины: частица не должна пройти больше ширины буфера (по соответствующей координате) за шаг. citeturn21search0
В TDMD‑TD эта идея усилена для TD‑time‑lag: буфер/skin связан не только с перестройкой таблиц, но и с временным лагом зон.

### Где реализация осознанно «уходит дальше теории» и почему
**Асинхронная практическая корректность поверх “идеального” TD.** Диссертационный формализм обычно описывается как достаточно детерминированная схема смены типов зон и передачи данных. Реальная же асинхронная MPI‑среда добавляет классы проблем, которые не всегда детально раскрываются в диссертационном описании (например, частично известная карта владельцев или несвежие сведения о держателях зон).
TDMD‑TD добавляет слой **версионируемого владения + pull‑запросы**, чтобы обеспечить прогресс и корректность при неблагоприятных порядках событий. Это полезно научно (можно доказательно сформулировать liveness при условиях доставки), но это уже «инженерная надстройка» к диссертации.

**Обобщение на deps‑граф вместо “1D/кольца”.** Диссертационная иллюстрация и базовое изложение опираются на разбиение вдоль оси и простую схему передачи. citeturn19search0
В TDMD‑TD v4.0+ вводится `DepsProvider`, что позволяет уходить к произвольному графу зависимостей (в т.ч. 3D‑соседству). Это расширяет область применимости, но требует отдельной доказательной части (см. ниже).

### Где остаются разрывы/непокрытые элементы диссертационного TD
**Полная формализация автомата “как в диссертации” на уровне событий.** Состояния зон присутствуют, но диссертационный стиль часто задаёт переходы как чёткий «регламент» (после приёма, при попадании в радиус, при старте расчёта, после завершения, и т.д.). В TDMD‑TD формальный core и deps‑готовность уже есть, но «таблица переходов по событиям» ещё нуждается в доведении до полностью специфицированного вида (с отдельным документом‑спецификацией, однозначными пред‑/пост‑условиями и доказуемым соответствием коду).

**Теоретическая часть корректности.** На v4.3 сделан большой шаг: введены измеряемые инварианты 3D‑support (`tG3/hG3/hV3`). Но ещё нет оформленного полного доказательства (индукция по `step_id`, леммы о сохранении support при доставке HALO/DELTA, и т.п.) — пока это «доказательство через проверяемые инварианты и регрессионные тесты», что хорошо для инженерии, но недостаточно для строгой публикации без дополнительного формального слоя.

## Что остаётся сделать: задачи и научно‑технические вызовы

### Завершение формализации TD‑автомата и доказательство корректности
**Что сделать.** Нужен документ и код‑контракт уровня «reference specification»:

- Полная таблица переходов `F/D/P/W/S` по событиям (`recv`, `deps_ready`, `start_compute`, `finish_compute`, `send`, `apply_delta`, `halo_ready`, …).
- Пред‑/пост‑условия для каждого перехода: какие множества атомов должны быть известны, какие таблицы валидны, какие `step_id` допустимы.
- Теорема корректности «в пределах буфера и ограничения лага»: силы, вычисленные в зоне `W`, эквивалентны силам эталонной последовательной МД для того же `step_id` (в пределах численной погрешности и допусков reorder‑суммирования).

**Почему это сложно.**
Потому что TD‑схема комбинирует: (1) асинхронные доставки данных, (2) динамическую миграцию атомов между зонами, (3) неоднозначность порядка суммирования сил (FP‑ассоциативность), (4) time‑lag по `step_id`. В строгом доказательстве нужно явно указать, что именно считается эквивалентностью (траектория, статистики, или сила‑на‑шаге) и какие допуски по времени/буферу допустимы.

### MPI‑реализация для полного 3D deps‑графа
К v4.3 есть 3D deps‑граф и 3D‑таблицы, но «полный 3D MPI‑режим» всё ещё является зоной повышенного риска.

**Что требуется для полноты.**
- Реализация устойчивых, масштабируемых коммуникаций по графу (а не по кольцу): обмен HALO/DELTA со всеми зависимыми владельцами зон.
- Устранение bottleneck‑паттернов вида «Iprobe в цикле по всем источникам» и переход к неблокирующим/пакетным обменам (или persistent communication), иначе добавление 26 соседей в 3D быстро «съест» время Python‑уровнем.
- Чёткое разделение каналов «табличные данные» vs «миграции владения» в 3D, иначе легко получить циклы ожидания.

**Научная трудность.**
В 3D резко возрастает количество зависимостей и появляется необходимость доказать liveness: что система не «зависает» при взаимных ожиданиях halo/owner‑deps (особенно если включены строгие owner‑deps с проверкой свежести).

### Полная реализация EAM и её включение в TD
**Статус на v4.3:** EAM отсутствует.
Чтобы проект стал применимым к металлам и дефектам, нужна реализация Embedded Atom Method.

**Почему EAM важен.**
В исходной статье Daw & Baskes формализуют EAM как метод, позволяющий получать свойства металлов и дефектов (параметр решётки, упругие константы, энергия сублимации, энергия образования вакансии и т. п.). citeturn14search3
Также в обзоре Daw подчёркиваются границы применимости: EAM лучше работает для «чисто металлических» систем без выраженной направленной (ковалентной) связи и заметного переноса заряда. citeturn14search15

**Ключевые научно‑технические сложности EAM в TD‑контексте.**
- EAM — **многотельный** потенциал: силы зависят от электронной плотности ρ, которая сама зависит от соседей. Это требует минимум **двух проходов**: (1) построить ρ, (2) построить силы с использованием производных embedding‑функции.
- Для TD и зонности надо аккуратно определить, какие halo‑данные нужны на каждом проходе, чтобы ρ и силы были согласованы по `step_id`.
- Давление/вириал для many‑body нужно считать корректно: в LAMMPS давление включает кинетический вклад и вириал, а вириал суммирует вклад не только парных, но и many‑body взаимодействий. citeturn14search2turn14search6

### Верификация «до уровня научной публикации»
К v4.3 уже есть мощная основа (verify2/verifylab/golden/chaos), но остаются важные усиления:

- Golden‑эталоны и chaos‑режим пока в первую очередь закрывают `td_local`. Для публикабельной верификации TD‑MPI нужно как минимум:
  - golden‑сравнение `td_full_mpi` против `serial` на малых системах,
  - 3D‑golden на малых N (например 2×2×2 FCC‑ячейки) для режимов `static_3d`,
  - отчётная статистика по инвариантам support/halo (ожидаемо нули по `tG3/hG3/hV3` в эталонных сценариях).
- Нужны тесты «на физику длинной траектории»: дрейф полной энергии в NVE, устойчивость давления и температуры при разных dt. Требование симплектичности и устойчивости интегратора для МД отдельно фиксируется в учебно‑диссертационных материалах. citeturn15view0

## Верификационный стенд v4.3: метрики, тест‑кейсы и научная валидность

### Набор метрик и зачем каждая нужна
В TDMD‑TD верификация строится вокруг двух классов метрик: (A) траекторные ошибки, (B) термодинамические наблюдаемые.

**Траекторные метрики**
- `max|dr|`, `max|dv|` (макс. расхождение координат и скоростей между эталоном и TD‑режимом).
  Эти метрики чувствительны к «потерянным взаимодействиям», ошибкам миграции и ошибкам порядка применения DELTA/HALO. Для корректности с PBC ошибки по `dr` должны оцениваться в minimum‑image норме (иначе перескок через границу коробки даст ложный большой `dr`).

**Термодинамические/механические метрики**
- Полная энергия **E = KE + PE** и дрейф **ΔE**. Дрейф энергии в NVE — главный индикатор повреждения симплектических свойств численного ядра или «утечек взаимодействий». Условие важности симплектической схемы для МД и использование Верле как схемы второго порядка прямо формулируются в источниках по МД. citeturn15view0
- Температура **T** из кинетической энергии (equipartition по степеням свободы). Формулы температуры через среднюю кинетическую энергию описаны стандартно. citeturn15view0
- Давление **P** по вириалу. В LAMMPS документация подчёркивает, что давление включает кинетический вклад и вириал; причём вириал суммирует вклады разных типов взаимодействий. citeturn14search2turn14search6

В текущем стенде (v4.3) давление реализовано в форме, корректной для парных потенциалов (LJ/Morse). При внедрении EAM потребуется расширить формулу/вклад вириала.

### Набор тест‑кейсов и почему он достаточен как «скелет» научной валидации
В v4.3 тест‑кейсы организованы так, чтобы покрывать разные режимы:

- **Разрежённый газ (gas)**: выявляет ошибки PBC, ошибки генерации скоростей, грубые ошибки cutoff/skin.
- **Кристалл FCC**: чувствителен к «долгим» накопительным ошибкам сил и к пропускам соседей; кристалл быстро деградирует при потере взаимодействий.
- **Кристалл BCC**: дополняет FCC и ловит геометрически иные конфигурации ближайших соседей.

Далее, для полноценной публикабельной валидации рекомендуется расширить: (1) жидкий LJ‑флюид (RDF/MSD), (2) дефекты (вакансия/межузельный атом) после внедрения EAM.

### Как golden и chaos обеспечивают научную строгость
- **Golden** превращает тесты в регрессионную систему: вместо «сравнить один раз» вы получаете «каждое изменение кода проверяется на воспроизводимость временных рядов E/T/P».
- **Chaos** агрессивно выбивает реализацию из «детерминированно‑удобного» порядка операций и имитирует неблагоприятную асинхронность (перестановка зон, задержка применения DELTA/HALO). Это критично для TD, потому что без chaos многие ошибки проявляются только при особых порядках событий.

## Зонные “Verlet‑таблицы”, локальные таблицы и MPI‑обмен: анализ и рекомендации к доведению «как в диссертации»

### Что уже близко к промышленным практикам MD
В МД для короткодействующих потенциалов стандарт: хранить пары в neighbor‑листе на радиус **cutoff + skin** и перестраивать лист реже, чем каждый шаг; LAMMPS прямо описывает, что в neighbor‑лист попадают пары на радиус «force cutoff + skin». citeturn14search12
Также типичный критерий перестройки — «если атом сдвинулся больше half‑skin», что явно прописано в документации (в разных версиях/зеркалах). citeturn14search24
Построение neighbor‑структуры через разбиение на bins/ячейки и stencil вокруг bin’а также описано в dev‑документации как стандартный способ эффективной сборки half‑neighbor list. citeturn14search0

В TDMD‑TD (v4.3) реализована зонная локальность в форме:
- персистентных cell‑bins (linked‑cells) для зоны с `rc=cutoff+skin`,
- перестройки/обновления по критериям смещения/возраста таблицы,
- хранения таблицы как **состояния зоны** (`InteractionTableState`) — это важно для TD, т.к. таблица становится объектом автомата.

### Что ещё нужно, чтобы “полностью реализовать диссертационный TD”
Диссертационный подход опирается на то, что зона проходит состояния и обменивается данными «дискретно по зонам», а локальность обусловлена радиусом взаимодействия. citeturn19search0turn20search0
Чтобы довести соответствие «до формального уровня», в TDMD‑TD стоит сделать следующие улучшения.

**Явная FSM‑спецификация (не только реализация)**
- Завести отдельный документ `docs/td_fsm_spec.md`, где как таблица фиксируются события и переходы.
- Синхронизировать документ с кодом через unit‑тесты, которые проверяют допустимость переходов (например, запрещено `S→W` без `recv`/`deps_ready`, и т.п.).
- Для 3D дополнить спецификацию геометрическими пред‑условиями (support AABB + pad).

**Единый интерфейс локальных таблиц**
Сейчас 1D и 3D используют разные реализации таблиц (zone‑bins vs celllist). Для устойчивости TD‑кода нужно ввести контракт уровня:

- `build_table(zid, support_ids, geom, rc, skin) -> Table`
- `table.query_neighbors(target_ids)` или `table.iter_pairs(target_ids)`
- `table.is_valid(step_id, max_age, max_disp)`

Это позволит:
- минимизировать ветвления в автомате,
- локализовать «точки корректности» (таблица отвечает за полноту пар, автомат отвечает за полноту данных).

**Полный 3D deps‑MPI как графовый обмен**
Структура deps‑графа должна стать основной: каждый rank обменивается с владельцами зависимых зон, а не с «соседом по кольцу». Это по духу ближе к классическим spatial‑decomposition алгоритмам (у Плимптона показано, что пространственная декомпозиция и обмен локальными данными — центральный путь масштабирования MD на распределённой памяти). citeturn24search1turn24search0
Разница в том, что TDMD‑TD делает это через TD‑состояния и time‑lag, но коммуникационный принцип «локальные соседи, локальные ghost/halo» остаётся основой.

## EAM в TDMD‑TD: требования к реализации и валидационные тесты

### Минимальная функциональная спецификация EAM
Чтобы считать EAM «реализованным», требуется:

- Поддержка табличных форматов (как минимум setfl/eam.alloy; желательно funcfl и eam.fs). Документация LAMMPS по `eam/alloy` фиксирует, что `pair_coeff` читает DYNAMO setfl файл и задаёт отображение элементов на типы атомов. citeturn14search1turn14search5
- Интерполяция табличных функций и их производных:
  - \(\phi(r)\), \(\rho(r)\), \(F(\rho)\), а также \(\phi'(r)\), \(\rho'(r)\), \(F'(\rho)\).
  Для устойчивости сил нужна по крайней мере гладкость первого производного; на практике используется кубический сплайн или высококачественная кусочно‑полиномиальная интерполяция.
- Два прохода (или эквивалентная схема):
  1) накопить \(\rho_i\) по соседям,
  2) посчитать силы с использованием \(F'(\rho)\) и парного вклада.
- Корректный вириал/напряжения для many‑body (и тестовая сверка): в LAMMPS документация подчёркивает, что virial учитывает many‑body вклады (а не только pair). citeturn14search2turn14search6

### Смеси (alloys): что нужно предусмотреть
- Маппинг «LAMMPS‑тип → элемент в таблице» как основной механизм (без mixing rules). Это прямо описано в документации `eam/alloy`. citeturn14search1
- Поддержка случая, когда файл содержит больше элементов, чем реально используется (типичный кейс для репозиториев потенциалов).

### Валидация EAM: какие тесты делать и почему именно они
Daw & Baskes подчёркивают, что из EAM‑формализма можно получать базовые свойства металлов и дефектов (параметр решётки, упругие константы, энергия сублимации, энергия вакансии). citeturn14search3
Следовательно, минимальный валидатор EAM должен включать:

- **0 K свойства кристалла (FCC/BCC/HCP где применимо):**
  - оптимизированный параметр решётки \(a_0\),
  - когезионная энергия,
  - упругие константы (через малые деформации и напряжения/вириал),
- **Дефекты:**
  - энергия вакансии,
  - энергия межузельного атома,
  - (опционально) поверхностная энергия/stacking fault — если потенциал заявляет такие свойства.
- **Сверка с эталонными потенциалами из репозиториев:** брать проверенные EAM‑таблицы из NIST Interatomic Potentials Repository (удобно для воспроизводимости и ссылок). citeturn14search33

## Сводная таблица: выполнено и осталось сделать

| Область | Статус на v4.3 | Что уже реализовано | Что остаётся | Сложность | Приоритет |
|---|---|---|---|---:|---:|
| TD‑автомат зон | Почти готово | `F/D/P/W/S`, formal core (≤1 W), deps‑готовность, time‑lag, support/halo/delta, pull‑REQ, версионность владельцев | Полная FSM‑спецификация «как документ+тест», формальная эквивалентность переходов диссертации | Высокая | Очень высокий |
| Доказательная корректность | В процессе | Набор инвариантов + runtime‑диагностика, 3D support‑инварианты `tG3/hG3/hV3` | Полное доказательство safety+liveness, формализация допусков эквивалентности | Очень высокая | Очень высокий |
| Верификация | Сильная база | verify2 (E/T/P), verifylab (свип+CSV+plots), golden, chaos | Golden/chaos для MPI и 3D режимов, длинные NVE‑тесты дрейфа энергии, RDF/MSD | Высокая | Очень высокий |
| 1D зонные таблицы | Реализовано | Персистентные zone‑bins, unwrapped z, rc=cutoff+skin, перестройка | Унификация интерфейса таблиц, ускорение (Numba/C++), строгий контроль потерь пар | Средняя | Высокий |
| 3D разбиение и deps‑граф | Реализовано (experimental) | 3D AABB‑зоны, deps‑граф через DepsProvider, 3D halo/overlap, 3D table=CellList | Полная масштабируемая MPI‑реализация по графу (nonblocking, batch), динамическое владение в 3D | Очень высокая | Очень высокий |
| EAM | Не сделано | — | Табличные форматы, интерполяция, 2‑pass, смеси, virial many‑body, тесты на решётках/дефектах | Очень высокая | Высокий (после стабилизации MPI+verify) |
| Производительность | Исследовательский уровень | Локальность через bins/celllist, сокращение O(N²) в силах | Профилирование, снижение Python overhead, ускорение коммуникаций | Высокая | Средний |

## Дорожная карта исследований и разработки после v4.3

### Ближайшие шаги, которые дадут максимальный научный эффект
**Шаг A: “verifylab‑MPI/3D” как главный критерий зрелости**
- Добавить режим `verifylab_mpi` (малые системы), где `td_full_mpi` сравнивается с `serial` по тем же метрикам E/T/P и по golden‑рядам.
- Ввести golden‑набор для 3D кейсов (малые FCC/BCC в кубе), а также golden‑нулевые ожидания по `tG3/hG3/hV3`.

**Ожидаемый результат:** воспроизводимая корректность TD‑MPI в 3D на уровне регрессии.

**Шаг B: формальная FSM‑спецификация и “спецификация‑тест”**
- Документ `td_fsm_spec.md` + тесты, проверяющие допустимость переходов и пред‑/пост‑условия (включая time‑lag и deps).
- Встраивание проверки инвариантов в CI как fail‑fast.

**Ожидаемый результат:** не просто «код работает», а «код следует спецификации TD‑автомата».

**Шаг C: MPI‑графовая коммуникация как основной путь**
- Уход от кольца к спискам соседних rank’ов по deps‑графу, неблокирующие обмены, пакетирование сообщений по получателю.
- Локальная оптимизация частоты HALO: отправлять только «необходимый минимум» для table‑deps (на основе таблицы), а не геометрического rc.

**Ожидаемый результат:** масштабируемость по числу рангов в 3D.

### Среднесрочные шаги: EAM и научные приложения
**Шаг D: EAM v1 (single‑element)**
- Реализация чтения funcfl или setfl‑single, интерполяции, 2‑pass плотности/сил, NVE‑стабильность.

**Шаг E: EAM v2 (alloy) + дефекты**
- Поддержка `eam/alloy`‑style маппинга типов на элементы по спецификации LAMMPS. citeturn14search1turn14search5
- Набор тестов: \(a_0\), \(E_{coh}\), vacancy energy, elastic constants. citeturn14search3turn14search33

**Ожидаемый результат:** переход TDMD‑TD от методического TD‑прототипа к инструменту для металлов и дефектов.

## Промпт для Codex‑агентов: автоматизация разработки, тестирования и документации

```text
ROLE: Ты — Codex-агент в проекте TDMD-TD (молекулярная динамика + TD-декомпозиция времени).
GOAL: Ускорить развитие после v4.3 без потери научной строгости. Любой PR должен:
  - поддерживать версионирование (bump patch/minor),
  - добавлять/обновлять тесты,
  - обновлять документы спецификаций и proof-заметки,
  - сохранять воспроизводимость verifylab/golden на эталонных кейсах.

REPO CONTEXT (важное):
  - tdmd/config.py: TDConfig содержит параметры td (zones, deps, max_step_lag, table_max_age, chaos, provider mode).
  - tdmd/td_automaton.py: TD-автомат зон, состояния F/D/P/W/S, deps-gating, time-lag gating, таблицы взаимодействий.
  - tdmd/td_full_mpi.py: MPI TD-обмен zone/halo/delta, протокол records, pull-REQ для halo/holder map.
  - tdmd/zones.py + tdmd/deps_provider*.py: 1D/3D разбиения и deps-граф.
  - tdmd/verify_v2.py, verify_lab.py, verify_golden.py: строгая верификация (E/T/P + golden + chaos).
  - docs/td_proofs_and_scaling.md: инварианты и план доказательств; v4.3 добавил 3D support-инварианты tG3/hG3/hV3.

AGENT TASK SET (выполняй в указанном порядке приоритета):

P0 — Verification “publication grade”
  1) Добавь verifylab_mpi:
     - запускает td_full_mpi на малых системах (np=2..4),
     - сравнивает с serial по E/T/P и max|dr|/max|dv|,
     - умеет писать CSV и PASS/FAIL по допускам.
  2) Добавь golden для MPI:
     - режим golden-gen-mpi: эталон/снимки для mpi-конфигураций,
     - режим golden-check-mpi: проверка td_full_mpi против эталона.
  3) Добавь 3D кейсы для golden:
     - gas_3d_small, fcc_3d_small, bcc_3d_small,
     - проверка нулевых инвариантов tG3/hG3/hV3.

P1 — Formal TD FSM spec
  4) Создай docs/td_fsm_spec.md:
     - таблица событий и переходов F/D/P/W/S,
     - pre/post-conditions на deps_ready, step_id constraints, table validity.
  5) Реализуй unit-тесты “spec compliance”:
     - тестирует, что запрещённые переходы не происходят,
     - тестирует, что при всех разрешённых переходах инварианты core не нарушаются.

P2 — 3D deps-graph MPI scaling
  6) Перепиши mpi-коммуникации на deps-graph:
     - вместо ring: список соседних rank’ов по deps_provider (owner_rank of deps zones),
     - неблокирующие Isend/Irecv, батчирование по dest,
     - устранить циклы Iprobe по всем источникам → использовать posted Irecv.
  7) Добавь профилирование:
     - таймеры на compute vs comm vs packing,
     - csv профайл по шагам.

P3 — EAM v1 + v2
  8) Реализуй EAM single-element:
     - чтение таблицы (минимум setfl/funcfl),
     - интерполяция + производные,
     - 2-pass rho then forces,
     - тесты на a0 и Ec (малый FCC, 0K релакс).
  9) Реализуй alloy mapping:
     - маппинг atom type → element,
     - тест на простой бинарный сплав (если есть таблица).
  10) Добавь virial for many-body:
     - давление/напряжения должны учитывать many-body вклад.

QUALITY GATES:
  - `python -m tdmd.main verifylab ...` должен проходить в baseline конфиге.
  - `pytest -q` должен проходить, включая golden/chaos.
  - Новые фичи должны идти с документом (docs/) и тестами (tests/).
  - Любые новые параметры должны быть добавлены в TDConfig с разумными defaults.

DELIVERABLES PER PR:
  - Код + тесты + обновлённые docs,
  - обновлённые release notes в `RELEASE_NOTES.md` (README не является changelog),
  - пример YAML в examples/ для новой функциональности.
```
