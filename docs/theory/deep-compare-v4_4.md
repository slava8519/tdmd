# TDMD‑TD v4.4: глубокая сверка с диссертацией и предыдущими отчётами

## Источники
- Диссертация: `docs/theory/декомпозиция времени.doc` (раздел 2, метод декомпозиции времени)
- Предыдущие сверки:
  - `docs/theory/deep-research-report.md` (v1.4)
  - `docs/theory/deep-research-report-2.md` (v4.3)

## Ключевые совпадения с диссертацией (фиксируем как «core»)
1. **Декомпозиция по зонам вдоль оси Z**
   - В диссертации модель делится на зоны вдоль Z, зона не меньше радиуса потенциала.
   - В коде: `ZoneLayout1DCells` и `zones_overlapping_range_pbc` реализуют 1D‑слэбы и p‑окрестность.

2. **Кольцевая архитектура и чередование send/recv**
   - В тексте явно описана кольцевая связность и порядок обменов для чётных/нечётных узлов.
   - В коде: `td_full_mpi.py` реализует parity‑раскладку send/recv и `prev_rank/next_rank`.

3. **Типы зон как состояния**
   - Диссертация вводит пять типов зон: готова к передаче, вычисляется, неполная, содержит данные, пустая.
   - В коде: `F/D/P/W/S` (см. `td_automaton.py` и `docs/SPEC_TD_AUTOMATON.md`).

4. **Буферная зона и критерий по скорости**
   - Формула ширины буфера в диссертации основана на max скорости за шаг.
   - В коде: `compute_zone_buffer_skin` учитывает max‑скорость и `max_step_lag`.

## Сопоставление с предыдущими сверками (что улучшилось к v4.4)
- **FSM‑спецификация оформлена**: есть `docs/SPEC_TD_AUTOMATON.md`.
- **Инварианты оформлены**: `docs/INVARIANTS.md` + тесты.
- **3D‑инварианты**: `tG3/hG3/hV3` внедрены в код и проверяются в smoke.
- **deps‑граф**: `DepsProvider` + `DepsProvider3DBlock`, документ `docs/DEPSGRAPH.md`.
- **Автокоррекция ширины зоны**: добавлена минимальная ширина зоны (`ZoneLayout1DCells.min_zone_width`), шаблон зон автоматически повышается до `ceil(cutoff/dz_cell)`.

## Расхождения/расширения относительно диссертации
1. **`static_rr` (статическое владение зоной)**
   - В диссертации описана кольцевая передача зон между процессорами.
   - В TDMD‑TD добавлен режим `static_rr`, где зоны остаются у владельцев (без REC_ZONE‑передач), а передаются только HALO/MIGRATION.
   - Это **расширение** теории и требует отдельного формального описания (в терминах зависимостей и корректности support).

2. **`deps_table`/`deps_owner` и holder‑карта**
   - Диссертация не описывает версионирование владельцев или pull‑механику.
   - В коде это добавлено для устойчивости асинхронности (инженерная надстройка).

3. **Зона может быть меньше cutoff (конфигурационно)**
   - Диссертация требует размер зоны вдоль Z не меньше радиуса взаимодействия.
   - В коде это не контролируется, зависит от конфигурации. Это потенциальный источник некорректных deps.

4. **3D deps‑граф**
   - Диссертация формулируется на 1D‑разбиении вдоль оси.
   - В коде реализована 3D‑геометрия и deps‑граф: это расширение и требует дополнительных инвариантов (что уже сделано частично).

## Рекомендации (следующие шаги, основанные на сверке)
1. **Зафиксировать в спецификации режим `static_rr`**
   - Добавить в `docs/SPEC_TD_AUTOMATON.md` и `docs/DEPSGRAPH.md` явную семантику: зонное владение фиксировано, REC_ZONE не используется.

2. **Проверка размера зоны vs cutoff**
   - Добавить рантайм‑валидацию в `ZoneLayout1DCells` (warning или assert), чтобы зона вдоль Z была >= cutoff.

3. **Документировать эквивалентность**
   - Описать в отдельном документе, какие свойства (силы/траектории/метрики) считаются эквивалентными между
     диссертационной схемой и расширенными режимами (`static_rr`, `static_3d`).

## Прямые ссылки на код/документы
- FSM: `docs/SPEC_TD_AUTOMATON.md`, `tdmd/td_automaton.py`.
- Инварианты: `docs/INVARIANTS.md`.
- Deps‑граф: `docs/DEPSGRAPH.md`, `tdmd/deps_provider_3d.py`.
- MPI‑ядро: `tdmd/td_full_mpi.py`.
